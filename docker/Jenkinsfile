pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'registry.example.com'
        IMAGE_NAME      = 'myapp'
        IMAGE_TAG       = "build-${env.BUILD_NUMBER}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Construire l\'image Docker') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'docker-registry-creds',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )
                ]) {
                    sh """
                        echo "Connexion au registre Docker : $DOCKER_REGISTRY"
                        docker login $DOCKER_REGISTRY -u "$DOCKER_USER" -p "$DOCKER_PASS"

                        echo "Build de l'image : $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
                        docker build -t $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG .
                    """
                }
            }
        }

        stage('Envoyer au registre') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'docker-registry-creds',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )
                ]) {
                    sh """
                        echo "Connexion au registre Docker : $DOCKER_REGISTRY"
                        docker login $DOCKER_REGISTRY -u "$DOCKER_USER" -p "$DOCKER_PASS"

                        echo "Push de l'image : $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG"
                        docker push $DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_TAG
                    """
                }
            }
        }

        stage('Déploiement') {
            when {
                expression { return false } // à remplacer par ta logique de déploiement
            }
            steps {
                sh """
                    echo "Ici tu mets ta commande de déploiement (kubectl, docker run, etc.)"
                """
            }
        }
    }

    post {
        always {
            // Optionnel : nettoyage local
            sh '''
                echo "Nettoyage local Docker (optionnel)"
                docker image prune -f || true
            '''
        }
    }
}
